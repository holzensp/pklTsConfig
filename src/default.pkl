module TsConfig.Default

import "schema.pkl" as Schema

import "base.pkl" as Base
import "strict.pkl" as Strict
import "strictest.pkl" as Strictest
import "transpiling.pkl" as Transpiling
import "nottranspiling.pkl" as NotTranspiling
import "library.pkl" as Library
import "monorepo.pkl" as Monorepo
import "dom.pkl" as Dom
import "notdom.pkl" as NotDom

config = new Schema.CompilerOptionsSchema{
  useBase = true
  useStrict = true
  useStrictest = false
  useDom = true
  useMonorepo = false
  useLibrary = false
  useTranspiling = true
}

root = new Schema.RootSchema {
  files = new Listing {}
  include = new Listing {}
  exclude = new Listing {}
}

amend = new Schema.AmendSchema { }

outputFileName:Schema.ValidOutputFileName = "tsconfig.json"

fixed aggregatedConfig = new Mapping {
  local items = new Listing {
    when (config.useBase) { Base.Base }
    when (config.useDom) { Dom.Dom }
    when (config.useStrict) { Strict.Strict }
    when (config.useStrictest) { Strictest.Strictest }
    when (config.useLibrary) { Library.Library }
    when (config.useMonorepo) { Monorepo.Monorepo }
    when (config.useTranspiling) { Transpiling.Transpiling }
    when (!config.useTranspiling) { NotTranspiling.NotTranspiling }
    when (!config.useDom) { NotDom.NotDom }
  }.fold(Map(), (acc, it) -> acc + it.toMap())

  ["compilerOptions"] =
    new Mapping {
      for(name, value in items) {
        [name] = if (!amend.isEmpty && amend.getOrNull(name) != null )
                    amend.getOrNull(name)
                 else
                    value
      }
      when(!amend.isEmpty) {
        for (name, value in amend) {
          when (items.getOrNull(name) == null) {
            [name] = value
          }
        }
      }
    }
  when (root.`extends` != "") { ["extends"] = root.`extends` }
  when (!root.files.isEmpty) { ["files"] = root.files }
  when (!root.include.isEmpty) { ["include"] = root.include }
  when (!root.exclude.isEmpty) { ["exclude"] = root.exclude }
}

output {
  renderer = new JsonRenderer {
    converters {
      [Boolean] = (it) -> "\(it)"
      [List] = (it) -> "[\(it[0])]"
    }
  }
  value = aggregatedConfig
  files {
    [if (outputFileName == "tsconfig.json") "totally_tsconfig.json" else outputFileName] = output
  }
}